# برنامه hServ

**برنامه `hserv`** یک ابزار command-line در Bash است که امکان اجرای پینگ TCP به سرور مشخص‌شده را فراهم می‌کند. این برنامه به کاربران اجازه می‌دهد تا سرور یا IP مورد نظر خود را چندین بار پینگ کنند و در نهایت میانگین زمان پینگ را دریافت کنند. با استفاده از این برنامه می‌توانید با مفاهیم مهم در Bash scripting آشنا شوید.

## 1. بخش‌های کلیدی برنامه

### 1.1 `function` و تعریف توابع

در این برنامه از دو تابع استفاده شده است:

- `display_help`: برای نمایش اطلاعات راهنما
- `tcping`: برای اجرای پینگ TCP و محاسبه میانگین

### 1.2. استفاده از `case` برای مدیریت دستورات

دستور `case` به ما کمک می‌کند تا ورودی‌های مختلف را بررسی کرده و دستور مناسبی را بر اساس آن‌ها اجرا کنیم.

### 1.3. استفاده از `shift` برای مدیریت پارامترهای ورودی

#### راهنما: `shift`

`shift` یک دستور داخلی در Bash است که برای مدیریت پارامترهای ورودی در اسکریپت‌های Bash استفاده می‌شود. این دستور پارامترهای ورودی را به یک موقعیت به سمت چپ انتقال می‌دهد؛ به این معنی که مقدار `$1` حذف شده و `$2` جای آن را می‌گیرد، و به همین ترتیب.

مثال ساده:

```bash
echo "First parameter: $1"
shift
echo "After shift, first parameter is now: $1"
```

در برنامه `hserv`، از `shift` برای حذف پارامترهایی که قبلاً پردازش شده‌اند (مانند `--retry`) استفاده می‌شود.

### 1.4. استفاده از `local` برای تعریف متغیرهای محلی در توابع

#### راهنما: `local`

دستور `local` در Bash برای تعریف متغیرهای محلی در توابع استفاده می‌شود. این دستور تضمین می‌کند که متغیرهای تعریف‌شده تنها درون همان تابع معتبر باشند و به خارج از آن دسترسی نداشته باشند. این کار باعث جلوگیری از تغییرات ناخواسته در متغیرهای خارج از تابع می‌شود.

مثال ساده:

```bash
function example {
    local var="Local Variable"
    echo "$var"
}
example  # خروجی: Local Variable
echo "$var"  # خروجی خالی، زیرا متغیر local خارج از تابع قابل دسترس نیست
```

در `hserv` از `local` برای تعریف متغیرهایی مانند `target` و `retries` استفاده شده است تا اطمینان حاصل شود که این متغیرها فقط درون تابع معتبر هستند و در بقیه اسکریپت تداخلی ایجاد نمی‌کنند.

---

## 2. تحلیل برنامه `hserv`

### تعریف تابع راهنما (`display_help`)

این تابع، اطلاعاتی درباره نحوه استفاده از برنامه را نمایش می‌دهد و به کاربران کمک می‌کند تا با گزینه‌های موجود در برنامه آشنا شوند.

```bash
function display_help() {
    echo "Usage: hserv [command] [options]"
    echo ""
    echo "Commands:"
    echo "  help                       Display this help message"
    echo "  tcping [IP|Domain]         Perform TCP ping to the specified IP address or domain"
    echo "      --retry [RETRY]        Number of retries (default is 3)"
}
```

این تابع به کاربران کمک می‌کند تا با دستورات مختلف (`help`، `tcping` و `--retry`) آشنا شوند و نحوه استفاده از آن‌ها را مشاهده کنند.

### تابع `tcping`

این تابع با استفاده از پارامترهای ورودی، پینگ TCP را به آدرس IP یا دامنه مشخص‌شده اجرا می‌کند. اگر کاربر از `--retry` استفاده کند، تعداد دفعات پینگ قابل تنظیم است؛ در غیر این صورت، مقدار پیش‌فرض 3 خواهد بود.

```bash
function tcping() {
    local target=$1
    local retries=3
    shift
```

در اینجا، از `local` برای تعریف متغیرهای `target` و `retries` استفاده شده است. `target` اولین پارامتر ورودی است که IP یا دامنه مورد نظر برای پینگ است، و `retries` تعداد دفعات تکرار پینگ را مشخص می‌کند.

---

## نکات تکمیلی برای مدیریت پارامترها و استفاده از `shift`

با استفاده از `shift` و `case` می‌توانیم به آسانی پارامترهای مختلف را مدیریت کنیم. در `tcping`، با هر `shift` یکی از پارامترهای ورودی جابه‌جا می‌شود و به این ترتیب پارامترهای بعدی در دسترس قرار می‌گیرند.

```bash
    # Parse options
    while [[ "$#" -gt 0 ]]; do
        case "$1" in
            --retry)
                retries="$2"
                shift 2
                ;;
            *)
                echo "Invalid option: $1"
                display_help
                exit 1
                ;;
        esac
    done
```

در این بخش:

- اگر گزینه `--retry` مشخص شده باشد، مقدار `retries` به مقدار ورودی کاربر تنظیم می‌شود.
- با `shift 2`، `--retry` و مقدار آن از لیست پارامترها حذف می‌شوند و پارامترهای بعدی به جلو جابه‌جا می‌شوند.

---

## اجرای پینگ و محاسبه میانگین

پس از بررسی پارامترها، تابع `tcping` پینگ TCP را به تعداد مشخص‌شده اجرا می‌کند و میانگین زمان پینگ را محاسبه می‌کند.

```bash
    # Perform the pings and calculate the average
    local total_time=0
    local count=0
    echo "Pinging $target $retries times..."

    for ((i=1; i<=retries; i++)); do
        local ping_time
        ping_time=$(ping -c 1 "$target" | grep 'time=' | awk -F'time=' '{print $2}' | awk '{print $1}')

        if [[ -n "$ping_time" ]]; then
            echo "Ping $i: $ping_time ms"
            total_time=$(echo "$total_time + $ping_time" | bc)
            ((count++))
        else
            echo "Ping $i: Failed"
        fi
    done
```

در اینجا:

- از یک حلقه `for` استفاده شده است تا پینگ TCP به تعداد مشخص‌شده تکرار شود.
- زمان هر پینگ از خروجی `ping` استخراج شده و در متغیر `ping_time` ذخیره می‌شود.
- اگر پینگ موفق باشد، مقدار آن به `total_time` اضافه می‌شود و شمارنده `count` افزایش می‌یابد.

در نهایت، میانگین زمان پینگ به شکل زیر محاسبه و نمایش داده می‌شود:

```bash
    if [[ "$count" -gt 0 ]]; then
        local avg_time
        avg_time=$(echo "$total_time / $count" | bc -l)
        printf "Average ping time: %.2f ms\n" "$avg_time"
    else
        echo "All pings failed."
    fi
```

---

## جمع‌بندی

این برنامه یک نمونه کاربردی و آموزشی برای مفاهیم مهم در Bash scripting است:

- **توابع**: تعریف توابع برای مدیریت کد و قابلیت استفاده مجدد.
- **`local`**: تعریف متغیرهای محلی برای جلوگیری از تداخل با سایر بخش‌های کد.
- **`shift`**: مدیریت پارامترهای ورودی به صورت پویا.
- **کنترل خطا**: نمایش پیام‌های راهنما در صورت اشتباه در ورودی و بررسی نتایج پینگ.
