# راهنمای جامع و کامل درباره Exit Code‌ها در Bash

در Bash، هر فرمان یا اسکریپت پس از اجرا یک کد خروجی (Exit Code) تولید می‌کند. این کد خروجی یک عدد است که نشان‌دهنده وضعیت اجرای فرمان یا اسکریپت می‌باشد. بررسی Exit Code برای تشخیص موفقیت یا شکست اجرای یک دستور بسیار اهمیت دارد و یکی از ابزارهای اصلی برای کنترل جریان برنامه در اسکریپت‌نویسی Bash است.

در این مستند، به‌صورت جامع به مفهوم Exit Code، نحوه استفاده و کاربردهای آن می‌پردازیم و جدول‌هایی برای یادآوری بهتر ارائه می‌کنیم.

## 1. مفهوم Exit Code

- **Exit Code** عددی است که پس از اجرای هر دستور یا اسکریپت به سیستم بازگردانده می‌شود. این عدد مشخص می‌کند که آیا اجرای فرمان با موفقیت انجام شده یا با خطا مواجه شده است.
- مقدار پیش‌فرض برای Exit Code موفقیت‌آمیز **0** است.
- هر مقدار غیر از صفر نشان‌دهنده یک خطا یا وضعیت خاص در اجرای دستور است.

### نکته:

Exit Code در متغیر ویژه `$?` ذخیره می‌شود. این متغیر پس از اجرای هر دستور مقدار آخرین Exit Code را نگه می‌دارد.

### مثال:

```bash
#!/bin/bash
ls /home/user  # دستور موفقیت‌آمیز
echo $?  # خروجی: 0

ls /nonexistent_directory  # دستور با خطا
echo $?  # خروجی: غیر صفر (مثلاً 2)
```

## 2. انواع Exit Code‌ها

### 2.1. Exit Code‌های استاندارد

| Exit Code | توضیحات                                                                       |
| --------- | ----------------------------------------------------------------------------- |
| 0         | موفقیت‌آمیز: دستور یا اسکریپت بدون خطا اجرا شده است.                          |
| 1         | خطای عمومی: یک خطای عمومی رخ داده است.                                        |
| 2         | خطای استفاده نادرست از فرمان: دستور یا فرمان به درستی استفاده نشده است.       |
| 126       | اجازه اجرا ندارید: دستور یافت شده است اما اجازه اجرا ندارید.                  |
| 127       | دستور یافت نشد: دستور در سیستم پیدا نشده است.                                 |
| 128       | خروج غیرعادی: یک سیگنال باعث خروج غیرعادی برنامه شده است.                     |
| 130       | قطع توسط کاربر: کاربر با فشردن Ctrl+C اجرای برنامه را متوقف کرده است.         |
| 255       | خطای خروج غیرمجاز: معمولاً نشان‌دهنده یک خطای غیرمجاز در خروج از اسکریپت است. |

### 2.2. Exit Code‌های مرتبط با سیگنال‌ها

وقتی یک فرمان یا اسکریپت توسط سیگنال‌هایی مانند SIGTERM یا SIGKILL متوقف می‌شود، یک Exit Code به مقدار 128+ شماره سیگنال برگردانده می‌شود.

| سیگنال  | شماره سیگنال | Exit Code | توضیحات                        |
| ------- | ------------ | --------- | ------------------------------ |
| SIGHUP  | 1            | 129       | قطع ارتباط ترمینال             |
| SIGINT  | 2            | 130       | قطع توسط کاربر (Ctrl+C)        |
| SIGKILL | 9            | 137       | خاتمه فرآیند (غیرقابل جلوگیری) |
| SIGTERM | 15           | 143       | خاتمه فرآیند با سیگنال خاتمه   |

### 2.3. Exit Code‌های کاربر

کاربران نیز می‌توانند به‌صورت دستی در اسکریپت‌های Bash Exit Code‌های دلخواه خود را تعیین کنند. برای این کار از دستور `exit` استفاده می‌شود.

#### مثال:

```bash
#!/bin/bash
# اسکریپت با موفقیت اجرا شده
exit 0
```

```bash
#!/bin/bash
# یک خطای سفارشی را برمی‌گرداند
exit 3
```

### جدول مقایسه مقادیر استاندارد Exit Code

| Exit Code | توضیحات                                       | مثال کاربرد                                |
| --------- | --------------------------------------------- | ------------------------------------------ |
| 0         | موفقیت‌آمیز: فرمان بدون مشکل اجرا شده است.    | اجرای `ls` در یک مسیر معتبر                |
| 1         | خطای عمومی: خطایی در اجرای فرمان رخ داده است. | فرمان با ورودی نادرست                      |
| 2         | خطای استفاده نادرست از فرمان.                 | اجرای `cp` بدون مشخص کردن مقصد فایل        |
| 126       | اجازه اجرا ندارید.                            | تلاش برای اجرای یک فایل بدون دسترسی اجرایی |
| 127       | دستور یافت نشد.                               | اجرای فرمانی که در سیستم نصب نشده است      |
| 128       | خروج غیرعادی برنامه به‌خاطر دریافت سیگنال.    | سیگنال‌های خارجی مثل SIGTERM               |
| 130       | قطع توسط کاربر (Ctrl+C).                      | اجرای طولانی مدت و قطع شدن توسط Ctrl+C     |
| 255       | خطای غیرمجاز در خروج از برنامه.               | خروج غیرمجاز از یک اسکریپت                 |

## 3. کاربرد Exit Code‌ها در Bash

Exit Code‌ها ابزارهای مهمی برای کنترل جریان اجرای اسکریپت‌ها و مدیریت خطا هستند. بررسی Exit Code هر دستور به شما امکان می‌دهد تا در صورت بروز خطا، اقدامات مناسبی انجام دهید یا خروجی‌های مناسب به کاربران نمایش دهید.

### مثال: استفاده از Exit Code در شرط‌ها (بدون if)

با استفاده از `[]` یا `[[]]` و بررسی مقدار `$?` می‌توانید پس از اجرای یک دستور، وضعیت آن را بررسی کنید.

#### مثال با `[]`:

```bash
#!/bin/bash
ls /some/directory
[ $? -eq 0 ] && echo "Command succeeded" || echo "Command failed"
```

در اینجا، اگر دستور `ls` موفقیت‌آمیز باشد، پیام "Command succeeded" چاپ می‌شود؛ در غیر این صورت، پیام "Command failed" چاپ می‌شود.

### 3.1. استفاده از `exit` برای خاتمه اسکریپت

در اسکریپت‌های Bash می‌توانید از دستور `exit` برای خاتمه اسکریپت و بازگرداندن یک Exit Code مشخص استفاده کنید.

#### مثال:

```bash
#!/bin/bash
if [ -z "$1" ]; then
  echo "Error: No argument provided."
  exit 1
fi

echo "Argument provided: $1"
exit 0
```

### 3.2. اجرای دستورات با وضعیت خطا

در برخی موارد، ممکن است بخواهید چندین دستور را پشت سر هم اجرا کنید و تنها در صورتی که یکی از دستورات با خطا مواجه شد، عملیات متوقف شود. برای این منظور می‌توانید از Exit Code استفاده کنید.

#### مثال:

```bash
#!/bin/bash
cp file1.txt /destination
[ $? -ne 0 ] && exit 1  # اگر خطا باشد، خروج با کد 1

mv file2.txt /destination
[ $? -ne 0 ] && exit 2  # اگر خطا باشد، خروج با کد 2
```

## 4. ابزارهای پیشرفته کار با Exit Code

### 4.1. استفاده از `set -e`

با استفاده از دستور `set -e`، اسکریپت در صورت بروز هرگونه خطا (هر دستور با Exit Code غیر صفر) به‌طور خودکار خاتمه می‌یابد. این ویژگی برای اسکریپت‌هایی که باید بدون خطا اجرا شوند مفید است.

#### مثال:

```bash
#!/bin/bash
set -e  # فعال کردن حالت خروج خودکار در صورت خطا
command1  # اگر این دستور خطا دهد، اسکریپت متوقف می‌شود
command2
```

### 4.2. استفاده از `trap` برای مدیریت خطاها

با استفاده از `trap` می‌توانید برای خطاهای خاص یا سیگنال‌ها، دستورات خاصی تعریف کنید که در صورت وقوع اجرا شوند.

#### مثال:

```bash
#!/bin/bash
trap 'echo "Error occurred! Exit code: $?"; exit' ERR  # مدیریت خطا

command1  # اگر این دستور خطا دهد، پیام نمایش داده می‌شود
command2
```

## جمع‌بندی

- **Exit Code‌ها** یکی از اجزای کلیدی Bash برای تشخیص موفقیت یا شکست دستورات هستند.
- مقدار **0** به معنای موفقیت و مقادیر غیر صفر به معنای خطا یا وضعیت خاصی هستند.
- **Exit Code‌های استاندارد** و **کاربر** به شما امکان می‌دهند تا جریان اجرای اسکریپت‌ها را کنترل کرده و خطاها را مدیریت کنید.
- ابزارهایی مانند `set -e` و `trap` برای مدیریت پیشرفته‌تر Exit Code‌ها در Bash ارائه شده‌اند.

### جدول خلاصه Exit Code‌ها

| Exit Code | توضیحات                                   |
| --------- | ----------------------------------------- |
| 0         | موفقیت‌آمیز: فرمان بدون خطا اجرا شده است. |
| 1         | خطای عمومی: فرمان با خطا مواجه شده است.   |
| 2         | استفاده نادرست از فرمان یا ورودی نادرست   |
| 126       | اجازه اجرا ندارید.                        |
| 127       | دستور یا فایل اجرایی یافت نشد.            |
| 128       | خروج غیرعادی به دلیل دریافت سیگنال        |
| 130       | قطع توسط کاربر (Ctrl+C).                  |
| 255       | خروج غیرمجاز از یک اسکریپت                |
